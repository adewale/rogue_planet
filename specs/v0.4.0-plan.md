# Rogue Planet v0.4.0 - Bug Fixes and Documentation

**Status**: Planning
**Target**: Address critical issues found in project audit (2025-10-26)

---

## Overview

Version 0.4.0 focuses on fixing broken features, missing files, and documentation gaps discovered during comprehensive audit. This is a **quality and correctness** release, not a feature release.

---

## Priority 1: BLOCKING ISSUES üî¥

These issues prevent users from getting started or break documented features.

### P1.1 - Missing examples/config.ini
- **Issue**: File referenced in Makefile (lines 182, 191, 204, 217) and examples/README.md doesn't exist
- **Impact**: `make examples` target fails completely
- **Fix**: Create comprehensive example config with all options documented
- **Estimate**: 1 hour
- **Files**: `examples/config.ini`

### P1.2 - macOS-specific sed in Makefile
- **Issue**: `sed -i ''` syntax (lines 194, 207, 220) fails on Linux
- **Impact**: `make examples` fails on Linux systems
- **Fix**: Use portable sed syntax or platform detection
- **Estimate**: 30 minutes
- **Files**: `Makefile`

### P1.3 - Missing QUICKSTART.md
- **Issue**: Referenced in examples/README.md:100, marked complete in TODO.md:88
- **Impact**: Broken documentation links, misleading TODO status
- **Options**:
  - Option A: Create QUICKSTART.md (5-minute setup guide)
  - Option B: Remove references and mark as v1.0 feature
- **Estimate**: 2 hours (Option A) or 15 minutes (Option B)
- **Files**: `QUICKSTART.md` or `examples/README.md`, `specs/TODO.md`

### P1.4 - Missing THEMES.md
- **Issue**: Referenced in examples/README.md:42,99, marked complete in TODO.md:88
- **Impact**: Broken documentation links
- **Options**:
  - Option A: Create comprehensive THEMES.md
  - Option B: Remove references and mark as v1.0 feature
- **Estimate**: 3 hours (Option A) or 15 minutes (Option B)
- **Files**: `THEMES.md` or `examples/README.md`, `specs/TODO.md`

### P1.5 - Missing setup-example-planet.sh
- **Issue**: Referenced in Makefile:172, file doesn't exist
- **Impact**: `make setup-example` fails
- **Options**:
  - Option A: Create script
  - Option B: Remove from Makefile (redundant with `make run-example`)
- **Recommendation**: Option B (already have run-example target)
- **Estimate**: 5 minutes
- **Files**: `Makefile`

---

## Priority 2: DOCUMENTATION GAPS üìù

### P2.1 - TODO.md Out of Sync
- **Issue**: Claims features complete that don't exist:
  - Line 88: "‚úÖ QUICKSTART.md" (doesn't exist)
  - Line 88: "‚úÖ THEMES.md" (doesn't exist)
  - Line 204: "‚úÖ golang.org/x/time/rate" (not in go.mod, never imported)
- **Impact**: Misleading project status, false sense of completion
- **Fix**: Update TODO.md to reflect actual state
- **Estimate**: 30 minutes
- **Files**: `specs/TODO.md`

### P2.2 - Undocumented Config Options
- **Issue**: `filter_by_first_seen` and `sort_by` implemented but not in README
- **Impact**: Users don't know these powerful features exist
- **Fix**: Add to README.md configuration section
- **Estimate**: 1 hour
- **Files**: `README.md`

### P2.3 - Rate Limiting Documentation
- **Issue**: CLAUDE.md claims rate limiting is a dependency (lines 119, 185)
- **Reality**: Not in go.mod, never imported, not implemented
- **Fix**: Remove from dependencies list, add to "Future Features" section
- **Estimate**: 15 minutes
- **Files**: `CLAUDE.md`

### P2.4 - 301 Redirect Documentation
- **Issue**: CLAUDE.md:188 claims "301/302 redirects (update feed URL in database for 301)"
- **Reality**: Crawler captures FinalURL but never updates database
- **Fix**: Clarify that redirects are *followed* but URLs aren't *auto-updated*
- **Estimate**: 10 minutes
- **Files**: `CLAUDE.md`

### P2.5 - Coverage Reporting Clarity
- **Issue**: TODO.md reports 88.4% average coverage, excludes cmd/rp (26.6%)
- **Impact**: Misleading "Excellent" rating when CLI has poor coverage
- **Fix**: Either include cmd/rp in average or note exclusion
- **Estimate**: 5 minutes
- **Files**: `specs/TODO.md`

---

## Priority 3: INCOMPLETE FEATURES ‚ö†Ô∏è

### P3.1 - Dry-Run Prune is a Stub
- **Issue**: `rp prune --dry-run` documented and implemented, but doesn't show what would be deleted
- **Current**: Just prints "Dry run: would delete entries older than N days"
- **Expected**: Should query and show entries that would be deleted
- **Fix**: Add query to count/preview entries before deletion
- **Estimate**: 1 hour
- **Files**: `cmd/rp/commands.go`

### P3.2 - 301 Redirect URL Updating
- **Issue**: Infrastructure exists (FinalURL field) but feature not implemented
- **Current**: Redirects followed, but feed URL in DB never updated
- **Impact**: Permanent redirects cause unnecessary work on every fetch
- **Options**:
  - Option A: Implement UpdateFeedURL() and auto-update on 301
  - Option B: Remove FinalURL field and defer to v1.0
- **Estimate**: 3 hours (Option A) or 1 hour (Option B)
- **Files**: `pkg/repository/repository.go`, `cmd/rp/commands.go`

### P3.3 - Feed Pause/Activate Commands
- **Issue**: Database has `active` field, queries filter by it, but no commands to change it
- **Current**: Only `rp remove-feed` (permanent deletion)
- **Wanted**: `rp pause-feed <url>` and `rp activate-feed <url>`
- **Impact**: Can't temporarily disable feeds without losing history
- **Estimate**: 2 hours
- **Files**: `pkg/repository/repository.go`, `cmd/rp/commands.go`, `cmd/rp/main.go`

### P3.4 - Rate Limiting
- **Issue**: Documented as key dependency but not implemented
- **Options**:
  - Option A: Implement per-domain rate limiting
  - Option B: Defer to v1.0 and fix documentation
- **Recommendation**: Option B (v0.4 is bug-fix release, not feature release)
- **Estimate**: N/A (deferred)
- **Files**: Documentation only

---

## Priority 4: CODE QUALITY üßπ

### P4.1 - Unused Subscribers Field
- **Issue**: `FeedData.Subscribers` field exists but always zero
- **Impact**: Dead code, misleading API
- **Fix**: Remove field or add TODO comment
- **Estimate**: 10 minutes
- **Files**: `pkg/generator/generator.go`

### P4.2 - SQL Injection Safety Comment
- **Issue**: `repository.go:369-376` uses fmt.Sprintf for field names (looks unsafe)
- **Reality**: Input is validated before formatting (safe)
- **Fix**: Add comment explaining why this is safe
- **Estimate**: 5 minutes
- **Files**: `pkg/repository/repository.go`

### P4.3 - FetchWithRetry Unused
- **Issue**: Method exists, well-tested, but never used in production
- **Impact**: Code duplication (retry logic could be used)
- **Options**:
  - Option A: Use FetchWithRetry in cmdFetch
  - Option B: Keep as public API for library users
- **Recommendation**: Option B (API completeness)
- **Estimate**: Add comment only (5 minutes)
- **Files**: `pkg/crawler/crawler.go`

### P4.4 - next_fetch/fetch_interval Unused
- **Issue**: Database fields exist, populated, indexed, but never consulted
- **Reality**: App always fetches ALL active feeds, ignoring schedule
- **Options**:
  - Option A: Implement intelligent scheduling
  - Option B: Remove fields (breaking DB change)
  - Option C: Keep for v1.0 feature, add comment
- **Recommendation**: Option C
- **Estimate**: 10 minutes (comments)
- **Files**: `pkg/repository/repository.go`

---

---

## Priority 5: CODE QUALITY IMPROVEMENTS üîß

**Note**: These are technical improvements, not bugs. Can be done in v0.4.0 or deferred to v1.1.

### P5.1 - HTTP Connection Pooling (QUICK WIN)
- **Issue**: HTTP client creates new connections for each fetch
- **Impact**: Slower fetching, more network overhead
- **Fix**: Configure connection pooling in crawler
```go
transport := &http.Transport{
    MaxIdleConns:        100,
    MaxIdleConnsPerHost: 10,
    IdleConnTimeout:     90 * time.Second,
}
```
- **Benefit**: 10-20% faster HTTP requests
- **Estimate**: 2 hours
- **Files**: `pkg/crawler/crawler.go`

### P5.2 - Config Validation on Load (QUICK WIN)
- **Issue**: Config validation happens late (on use), not on load
- **Impact**: Unclear error messages, late failure
- **Fix**: Call `cfg.Validate()` inside `LoadFromFile()`
- **Benefit**: Fail fast with clear errors
- **Estimate**: 2 hours
- **Files**: `pkg/config/config.go`

### P5.3 - Export Sentinel Errors (QUICK WIN)
- **Issue**: Some packages export errors (crawler, repository), some don't (normalizer, generator)
- **Impact**: Inconsistent error checking, can't use `errors.Is()`
- **Fix**: Add `errors.go` to normalizer and generator packages
```go
// pkg/normalizer/errors.go
var (
    ErrInvalidFeed = errors.New("invalid feed data")
    ErrNoEntries   = errors.New("feed contains no entries")
)
```
- **Benefit**: Better error handling for callers
- **Estimate**: 4 hours
- **Files**: `pkg/normalizer/errors.go`, `pkg/generator/errors.go`

### P5.4 - Improve cmd/rp Test Coverage
- **Issue**: Only 26.6% coverage vs 80-96% in libraries
- **Impact**: Many command paths untested
- **Fix**: Add 20-30 command-level tests
- **Benefit**: Catch command regressions
- **Estimate**: 2 days
- **Files**: `cmd/rp/*_test.go`

**Quick Wins Total**: 1 day (P5.1 + P5.2 + P5.3)
**With Test Coverage**: 3 days (add P5.4)

### Deferred to v1.1 (Larger Architectural Changes)

These are recommended but require more substantial refactoring:

- **Introduce Interfaces** (2 days) - FeedRepository, FeedCrawler, FeedNormalizer interfaces
- **Extract Business Logic** (3 days) - Create pkg/fetcher, move fetchFeeds() logic
- **Context Propagation** (1 day) - Proper context handling, graceful shutdown
- **Structured Logging** (2 days) - Replace global logger with slog
- **Performance Optimizations** (2 days) - Prepared statement reuse, batch inserts
- **Code Organization** (1 day) - Split large files (generator.go, repository.go)

**Total Deferred**: 11 days (2+ weeks)

See `specs/code-quality-improvements.md` for full details.

---

## Testing Requirements

All fixes must include:
- [ ] Unit tests for new functionality
- [ ] Integration tests for command changes
- [ ] Documentation updates
- [ ] CHANGELOG.md entry

### Test Coverage Goals
- Maintain >75% coverage on all library packages
- Improve cmd/rp coverage from 26.6% to >40% (if P5.4 included)

---

## Implementation Plan

### Phase 1: Critical Fixes (1 day)
1. Create examples/config.ini
2. Fix Makefile sed compatibility
3. Decide on QUICKSTART.md/THEMES.md (create or remove)
4. Remove setup-example-planet.sh from Makefile
5. Update TODO.md to reflect reality

### Phase 2: Documentation (0.5 days)
1. Document filter_by_first_seen and sort_by
2. Fix rate limiting docs
3. Clarify 301 redirect status
4. Update coverage reporting

### Phase 3: Feature Fixes (1 day)
1. Implement proper dry-run prune
2. Decide on 301 redirect feature (implement or defer)
3. Add pause/activate feed commands

### Phase 4: Code Cleanup (0.5 days)
1. Remove/comment unused fields
2. Add SQL safety comments
3. Document FetchWithRetry status
4. Comment scheduling fields

### Phase 5: Quick Quality Wins (OPTIONAL - 1 day)
1. HTTP connection pooling (P5.1) - 2 hours
2. Config validation on load (P5.2) - 2 hours
3. Export sentinel errors (P5.3) - 4 hours

### Total Estimate: 3 days (base) or 4 days (with Phase 5)

---

## Release Criteria

Version 0.4.0 can be released when:
- [ ] All P1 (blocking) issues resolved
- [ ] All P2 (documentation) issues resolved
- [ ] At least 2 of 4 P3 (incomplete features) resolved
- [ ] P4 code cleanup complete
- [ ] All tests passing
- [ ] CHANGELOG.md updated
- [ ] README.md reflects actual features
- [ ] TODO.md synchronized with reality
- [ ] `make examples` works on both macOS and Linux

**Optional (Phase 5)**:
- [ ] P5.1-P5.3 quick wins implemented (adds 1 day)
- [ ] HTTP connection pooling added
- [ ] Config validation on load
- [ ] Sentinel errors exported

---

## Out of Scope (Deferred to v1.0)

- Feed autodiscovery
- Per-domain rate limiting
- Intelligent feed scheduling (adaptive polling)
- Binary distribution packages
- Production deployment documentation

**Deferred to v1.1** (Large Architectural Changes):
- Interfaces for all packages
- Business logic extraction (pkg/fetcher)
- Context propagation improvements
- Structured logging (slog)
- Performance optimizations (prepared statements, batch inserts)
- Code organization (split large files)

---

## Success Metrics

- ‚úÖ Zero broken Makefile targets
- ‚úÖ Zero broken documentation links
- ‚úÖ TODO.md 100% accurate
- ‚úÖ All documented flags work as described
- ‚úÖ Portable build (works on Linux and macOS)

**If Phase 5 included**:
- ‚úÖ 10-20% faster HTTP fetching (connection pooling)
- ‚úÖ Fail-fast config validation
- ‚úÖ Consistent error handling across packages
