# Rogue Planet v0.4.0 - Bug Fixes and Documentation

**Status**: Planning
**Target**: Address critical issues found in project audit (2025-10-26)

---

## Overview

Version 0.4.0 focuses on fixing broken features, missing files, and documentation gaps discovered during comprehensive audit. This is a **quality and correctness** release, not a feature release.

---

## Priority 1: BLOCKING ISSUES üî¥

These issues prevent users from getting started or break documented features.

### P1.1 - Missing examples/config.ini
- **Issue**: File referenced in Makefile (lines 182, 191, 204, 217) and examples/README.md doesn't exist
- **Impact**: `make examples` target fails completely
- **Fix**: Create comprehensive example config with all options documented
- **Estimate**: 1 hour
- **Files**: `examples/config.ini`

### P1.2 - macOS-specific sed in Makefile
- **Issue**: `sed -i ''` syntax (lines 194, 207, 220) fails on Linux
- **Impact**: `make examples` fails on Linux systems
- **Fix**: Use portable sed syntax or platform detection
- **Estimate**: 30 minutes
- **Files**: `Makefile`

### P1.3 - Missing QUICKSTART.md
- **Issue**: Referenced in examples/README.md:100, marked complete in TODO.md:88
- **Impact**: Broken documentation links, misleading TODO status
- **Options**:
  - Option A: Create QUICKSTART.md (5-minute setup guide)
  - Option B: Remove references and mark as v1.0 feature
- **Estimate**: 2 hours (Option A) or 15 minutes (Option B)
- **Files**: `QUICKSTART.md` or `examples/README.md`, `specs/TODO.md`

### P1.4 - Missing THEMES.md
- **Issue**: Referenced in examples/README.md:42,99, marked complete in TODO.md:88
- **Impact**: Broken documentation links
- **Options**:
  - Option A: Create comprehensive THEMES.md
  - Option B: Remove references and mark as v1.0 feature
- **Estimate**: 3 hours (Option A) or 15 minutes (Option B)
- **Files**: `THEMES.md` or `examples/README.md`, `specs/TODO.md`

### P1.5 - Missing setup-example-planet.sh
- **Issue**: Referenced in Makefile:172, file doesn't exist
- **Impact**: `make setup-example` fails
- **Options**:
  - Option A: Create script
  - Option B: Remove from Makefile (redundant with `make run-example`)
- **Recommendation**: Option B (already have run-example target)
- **Estimate**: 5 minutes
- **Files**: `Makefile`

---

## Priority 2: DOCUMENTATION GAPS üìù

### P2.1 - TODO.md Out of Sync
- **Issue**: Claims features complete that don't exist:
  - Line 88: "‚úÖ QUICKSTART.md" (doesn't exist)
  - Line 88: "‚úÖ THEMES.md" (doesn't exist)
  - Line 204: "‚úÖ golang.org/x/time/rate" (not in go.mod, never imported)
- **Impact**: Misleading project status, false sense of completion
- **Fix**: Update TODO.md to reflect actual state
- **Estimate**: 30 minutes
- **Files**: `specs/TODO.md`

### P2.2 - Undocumented Config Options
- **Issue**: `filter_by_first_seen` and `sort_by` implemented but not in README
- **Impact**: Users don't know these powerful features exist
- **Fix**: Add to README.md configuration section
- **Estimate**: 1 hour
- **Files**: `README.md`

### P2.3 - Rate Limiting Documentation
- **Issue**: CLAUDE.md claims rate limiting is a dependency (lines 119, 185)
- **Reality**: Not in go.mod, never imported, not implemented
- **Fix**: Remove from dependencies list, add to "Future Features" section
- **Estimate**: 15 minutes
- **Files**: `CLAUDE.md`

### P2.4 - 301 Redirect Documentation
- **Issue**: CLAUDE.md:188 claims "301/302 redirects (update feed URL in database for 301)"
- **Reality**: Crawler captures FinalURL but never updates database
- **Fix**: Clarify that redirects are *followed* but URLs aren't *auto-updated*
- **Estimate**: 10 minutes
- **Files**: `CLAUDE.md`

### P2.5 - Coverage Reporting Clarity
- **Issue**: TODO.md reports 88.4% average coverage, excludes cmd/rp (26.6%)
- **Impact**: Misleading "Excellent" rating when CLI has poor coverage
- **Fix**: Either include cmd/rp in average or note exclusion
- **Estimate**: 5 minutes
- **Files**: `specs/TODO.md`

### P2.6 - Atom Torture Test Research
- **Issue**: Test fixtures based on web search results, not original Jacques Distler blog posts
- **Impact**: May be missing edge cases from original torture tests
- **Background**:
  - Test fixtures exist: atom-torture-xhtml.xml, atom-torture-mathml.xml, atom-torture-svg.xml
  - Test suite implemented: normalizer_torture_test.go
  - Based on secondary sources during implementation
  - Direct blog access blocked: golem.ph.utexas.edu/~distler/blog/archives/000793.html (April 2006)
- **Fix Tasks**:
  - [ ] Access original blog posts (use archive.org if needed)
  - [ ] Compare with current test fixtures (5 XHTML, 6 MathML, 7 SVG tests)
  - [ ] Document specific edge cases Distler described
  - [ ] Add missing test cases if any found
  - [ ] Document policy decisions (strip vs preserve MathML/SVG)
  - [ ] Add references to original posts in test comments
- **Estimate**: 4 hours (research) + 2 hours (updates if needed)
- **Files**: `testdata/atom-torture-*.xml`, `pkg/normalizer/normalizer_torture_test.go`, `CLAUDE.md`

---

## Priority 3: INCOMPLETE FEATURES ‚ö†Ô∏è

### P3.1 - Dry-Run Prune is a Stub
- **Issue**: `rp prune --dry-run` documented and implemented, but doesn't show what would be deleted
- **Current**: Just prints "Dry run: would delete entries older than N days"
- **Expected**: Should query and show entries that would be deleted
- **Fix**: Add query to count/preview entries before deletion
- **Estimate**: 1 hour
- **Files**: `cmd/rp/commands.go`

### P3.2 - 301 Redirect URL Updating
- **Issue**: Infrastructure exists (FinalURL field) but feature not implemented
- **Current**: Redirects followed, but feed URL in DB never updated
- **Impact**: Permanent redirects cause unnecessary work on every fetch
- **Options**:
  - Option A: Implement UpdateFeedURL() and auto-update on 301
  - Option B: Remove FinalURL field and defer to v1.0
- **Estimate**: 3 hours (Option A) or 1 hour (Option B)
- **Files**: `pkg/repository/repository.go`, `cmd/rp/commands.go`

### P3.3 - Feed Pause/Activate Commands
- **Issue**: Database has `active` field, queries filter by it, but no commands to change it
- **Current**: Only `rp remove-feed` (permanent deletion)
- **Wanted**: `rp pause-feed <url>` and `rp activate-feed <url>`
- **Impact**: Can't temporarily disable feeds without losing history
- **Estimate**: 2 hours
- **Files**: `pkg/repository/repository.go`, `cmd/rp/commands.go`, `cmd/rp/main.go`

### P3.4 - Rate Limiting
- **Issue**: Documented as key dependency but not implemented
- **Options**:
  - Option A: Implement per-domain rate limiting
  - Option B: Defer to v1.0 and fix documentation
- **Recommendation**: Option B (v0.4 is bug-fix release, not feature release)
- **Estimate**: N/A (deferred)
- **Files**: Documentation only

---

## Priority 4: CODE QUALITY üßπ

### P4.1 - Unused Subscribers Field
- **Issue**: `FeedData.Subscribers` field exists but always zero
- **Impact**: Dead code, misleading API
- **Fix**: Remove field or add TODO comment
- **Estimate**: 10 minutes
- **Files**: `pkg/generator/generator.go`

### P4.2 - SQL Injection Safety Comment
- **Issue**: `repository.go:369-376` uses fmt.Sprintf for field names (looks unsafe)
- **Reality**: Input is validated before formatting (safe)
- **Fix**: Add comment explaining why this is safe
- **Estimate**: 5 minutes
- **Files**: `pkg/repository/repository.go`

### P4.3 - FetchWithRetry Unused
- **Issue**: Method exists, well-tested, but never used in production
- **Impact**: Code duplication (retry logic could be used)
- **Options**:
  - Option A: Use FetchWithRetry in cmdFetch
  - Option B: Keep as public API for library users
- **Recommendation**: Option B (API completeness)
- **Estimate**: Add comment only (5 minutes)
- **Files**: `pkg/crawler/crawler.go`

### P4.4 - next_fetch/fetch_interval Unused
- **Issue**: Database fields exist, populated, indexed, but never consulted
- **Reality**: App always fetches ALL active feeds, ignoring schedule
- **Options**:
  - Option A: Implement intelligent scheduling
  - Option B: Remove fields (breaking DB change)
  - Option C: Keep for v1.0 feature, add comment
- **Recommendation**: Option C
- **Estimate**: 10 minutes (comments)
- **Files**: `pkg/repository/repository.go`

---

---

## Priority 5: CODE QUALITY IMPROVEMENTS üîß

**Note**: These are technical improvements, not bugs. Can be done in v0.4.0 or deferred to v1.1.

### P5.1 - HTTP Connection Pooling (QUICK WIN)
- **Issue**: HTTP client creates new connections for each fetch
- **Impact**: Slower fetching, more network overhead
- **Fix**: Configure connection pooling in crawler
```go
transport := &http.Transport{
    MaxIdleConns:        100,
    MaxIdleConnsPerHost: 10,
    IdleConnTimeout:     90 * time.Second,
}
```
- **Benefit**: 10-20% faster HTTP requests
- **Estimate**: 2 hours
- **Files**: `pkg/crawler/crawler.go`

### P5.2 - Config Validation on Load (QUICK WIN)
- **Issue**: Config validation happens late (on use), not on load
- **Impact**: Unclear error messages, late failure
- **Fix**: Call `cfg.Validate()` inside `LoadFromFile()`
- **Benefit**: Fail fast with clear errors
- **Estimate**: 2 hours
- **Files**: `pkg/config/config.go`

### P5.3 - Export Sentinel Errors (QUICK WIN)
- **Issue**: Some packages export errors (crawler, repository), some don't (normalizer, generator)
- **Impact**: Inconsistent error checking, can't use `errors.Is()`
- **Fix**: Add `errors.go` to normalizer and generator packages
```go
// pkg/normalizer/errors.go
var (
    ErrInvalidFeed = errors.New("invalid feed data")
    ErrNoEntries   = errors.New("feed contains no entries")
)
```
- **Benefit**: Better error handling for callers
- **Estimate**: 4 hours
- **Files**: `pkg/normalizer/errors.go`, `pkg/generator/errors.go`

### P5.4 - Improve cmd/rp Test Coverage
- **Issue**: Only 26.6% coverage vs 80-96% in libraries
- **Impact**: Many command paths untested
- **Fix**: Add 20-30 command-level tests
- **Benefit**: Catch command regressions
- **Estimate**: 2 days
- **Files**: `cmd/rp/*_test.go`

**Quick Wins Total**: 1 day (P5.1 + P5.2 + P5.3)
**With Test Coverage**: 3 days (add P5.4)

### Deferred to v1.1 (Larger Architectural Changes)

These are recommended but require more substantial refactoring. See full implementation details below in "Deferred Work: Detailed Plan" section.

**Summary**:
- **Introduce Interfaces** (2 days) - FeedRepository, FeedCrawler, FeedNormalizer interfaces
- **Extract Business Logic** (3 days) - Create pkg/fetcher, move fetchFeeds() logic
- **Context Propagation** (1 day) - Proper context handling, graceful shutdown
- **Structured Logging** (2 days) - Replace global logger with slog
- **Performance Optimizations** (2 days) - Prepared statement reuse, batch inserts
- **Code Organization** (1 day) - Split large files (generator.go, repository.go)

**Total Deferred**: 11 days (2+ weeks)

---

## Testing Requirements

All fixes must include:
- [ ] Unit tests for new functionality
- [ ] Integration tests for command changes
- [ ] Documentation updates
- [ ] CHANGELOG.md entry

### Test Coverage Goals
- Maintain >75% coverage on all library packages
- Improve cmd/rp coverage from 26.6% to >40% (if P5.4 included)

---

## Implementation Plan

### Phase 1: Critical Fixes (1 day)
1. Create examples/config.ini
2. Fix Makefile sed compatibility
3. Decide on QUICKSTART.md/THEMES.md (create or remove)
4. Remove setup-example-planet.sh from Makefile
5. Update TODO.md to reflect reality

### Phase 2: Documentation (1 day)
1. Document filter_by_first_seen and sort_by
2. Fix rate limiting docs
3. Clarify 301 redirect status
4. Update coverage reporting
5. Atom Torture Test research and updates (optional)

### Phase 3: Feature Fixes (1 day)
1. Implement proper dry-run prune
2. Decide on 301 redirect feature (implement or defer)
3. Add pause/activate feed commands

### Phase 4: Code Cleanup (0.5 days)
1. Remove/comment unused fields
2. Add SQL safety comments
3. Document FetchWithRetry status
4. Comment scheduling fields

### Phase 5: Quick Quality Wins (OPTIONAL - 1 day)
1. HTTP connection pooling (P5.1) - 2 hours
2. Config validation on load (P5.2) - 2 hours
3. Export sentinel errors (P5.3) - 4 hours

### Total Estimate: 3.5 days (base) or 4.5 days (with Phase 5)

**Note**: Base estimate includes Atom Torture Test research (P2.6). Estimate assumes QUICKSTART/THEMES are removed rather than created (faster option).

---

## Release Criteria

Version 0.4.0 can be released when:
- [ ] All P1 (blocking) issues resolved
- [ ] All P2 (documentation) issues resolved
- [ ] At least 2 of 4 P3 (incomplete features) resolved
- [ ] P4 code cleanup complete
- [ ] All tests passing
- [ ] CHANGELOG.md updated
- [ ] README.md reflects actual features
- [ ] TODO.md synchronized with reality
- [ ] `make examples` works on both macOS and Linux

**Optional (Phase 5)**:
- [ ] P5.1-P5.3 quick wins implemented (adds 1 day)
- [ ] HTTP connection pooling added
- [ ] Config validation on load
- [ ] Sentinel errors exported

---

## Out of Scope (Deferred to v1.0)

- Feed autodiscovery
- Per-domain rate limiting
- Intelligent feed scheduling (adaptive polling)
- Binary distribution packages
- Production deployment documentation

**Deferred to v1.1** (Large Architectural Changes):
- Interfaces for all packages
- Business logic extraction (pkg/fetcher)
- Context propagation improvements
- Structured logging (slog)
- Performance optimizations (prepared statements, batch inserts)
- Code organization (split large files)

---

## Success Metrics

- ‚úÖ Zero broken Makefile targets
- ‚úÖ Zero broken documentation links
- ‚úÖ TODO.md 100% accurate
- ‚úÖ All documented flags work as described
- ‚úÖ Portable build (works on Linux and macOS)

**If Phase 5 included**:
- ‚úÖ 10-20% faster HTTP fetching (connection pooling)
- ‚úÖ Fail-fast config validation
- ‚úÖ Consistent error handling across packages

---
---

# DEFERRED WORK: Detailed Plan for v1.1+

This section contains the comprehensive code quality improvement plan deferred to post-v1.0.0 releases. These are **not bugs** but architectural improvements to increase maintainability, testability, and robustness.

**Current State**: B+ quality code
- ‚úÖ Good: Error wrapping, resource cleanup, no library logging, security-first
- ‚ö†Ô∏è  Needs Work: Test coverage (26.6% cmd/rp), no interfaces, large functions, global state

**Target State**: A quality code
- Testable architecture with interfaces
- >60% coverage on cmd/rp
- Separated concerns (business logic vs orchestration)
- Context propagation
- Structured logging

---

## D1: Architecture & Testability üèóÔ∏è

### D1.1 Introduce Interfaces for Core Dependencies

**Problem**: All code depends on concrete types (crawler.Crawler, repository.Repository, etc.). This makes testing harder and couples components tightly.

**Current**:
```go
func fetchFeeds(cfg *config.Config) error {
    repo, err := repository.New(cfg.Database.Path)  // Concrete type
    c := crawler.NewWithUserAgent(cfg.Planet.UserAgent)  // Concrete type
    n := normalizer.New()  // Concrete type
    // ...
}
```

**Proposed**: Define interfaces in pkg packages:

```go
// pkg/repository/interface.go
type FeedRepository interface {
    GetFeeds(activeOnly bool) ([]Feed, error)
    AddFeed(url, title string) (int64, error)
    UpdateFeedCache(id int64, etag, lastModified string, lastFetched time.Time) error
    UpsertEntry(entry *Entry) error
    // ... other methods
}

// pkg/crawler/interface.go
type FeedCrawler interface {
    Fetch(ctx context.Context, feedURL string, cache FeedCache) (*FeedResponse, error)
}

// pkg/normalizer/interface.go
type FeedNormalizer interface {
    Parse(feedData []byte, feedURL string, fetchTime time.Time) (*FeedMetadata, []Entry, error)
}
```

**Benefits**:
- Easy to mock for testing
- Dependency injection possible
- Can swap implementations (e.g., test database)
- Clear contracts between components

**Estimate**: 2 days
**Files**: Create `interface.go` in each pkg/

---

### D1.2 Extract Business Logic from fetchFeeds()

**Problem**: `fetchFeeds()` in commands.go is 143 lines mixing orchestration, concurrency, and business logic. Hard to test individual pieces.

**Current Structure** (817-919):
```go
func fetchFeeds(cfg *config.Config) error {
    // Setup (20 lines)
    // Concurrency control (10 lines)
    // Goroutine with fetch logic (90 lines)
    // Wait and cleanup (5 lines)
}
```

**Proposed**: Extract to pkg/fetcher with interfaces

```go
// pkg/fetcher/fetcher.go
type Fetcher struct {
    repo       repository.FeedRepository
    crawler    crawler.FeedCrawler
    normalizer normalizer.FeedNormalizer
    logger     Logger
}

func (f *Fetcher) FetchFeed(ctx context.Context, feed repository.Feed) error {
    // Single feed fetch logic (50 lines)
    // No concurrency here - that's orchestration
}

func (f *Fetcher) FetchAllFeeds(ctx context.Context, concurrency int) error {
    // Orchestrate concurrent fetches (40 lines)
    // Uses semaphore pattern
}
```

**Benefits**:
- Business logic testable without goroutines
- Clear separation: fetcher package = logic, commands = CLI
- Can test single feed fetch independently
- Context properly propagated

**Estimate**: 3 days
**Files**: Create `pkg/fetcher/`, refactor `cmd/rp/commands.go`

---

### D1.3 Improve Test Coverage for cmd/rp

**Problem**: Only 26.6% coverage vs 80-96% in library packages.

**Current Coverage**:
```
cmd/rp:          26.6%  ‚ö†Ô∏è
pkg/crawler:     96.6%  ‚úÖ
pkg/config:      93.8%  ‚úÖ
pkg/opml:        91.8%  ‚úÖ
```

**Missing Tests**:
- [ ] Command execution paths (init, add-feed, etc.)
- [ ] Error handling in commands
- [ ] Config validation flows
- [ ] Output formatting

**Proposed Tests**:
```go
// cmd/rp/commands_test.go
func TestCmdInit_Success(t *testing.T) { ... }
func TestCmdInit_ConfigExists(t *testing.T) { ... }
func TestCmdAddFeed_InvalidURL(t *testing.T) { ... }
func TestCmdAddFeed_DatabaseError(t *testing.T) { ... }
func TestCmdListFeeds_EmptyDatabase(t *testing.T) { ... }
func TestCmdStatus_OutputFormat(t *testing.T) { ... }
// ... 20-30 more tests
```

**Target**: >60% coverage (currently 26.6%)

**Estimate**: 2 days
**Files**: Expand `cmd/rp/*_test.go`

---

## D2: Context & Concurrency üîÑ

### D2.1 Proper Context Propagation

**Problem**: Creating `context.Background()` inside goroutines instead of passing parent context from command.

**Current** (commands.go:838):
```go
go func(index int, f repository.Feed) {
    defer wg.Done()
    // ...
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    resp, err := c.Fetch(ctx, f.URL, cache)
    cancel()
    // ...
}(i, feed)
```

**Issue**: Can't cancel all goroutines if user hits Ctrl+C

**Proposed**:
```go
func fetchFeeds(ctx context.Context, cfg *config.Config) error {
    // ...
    for i, feed := range feeds {
        wg.Add(1)
        go func(index int, f repository.Feed) {
            defer wg.Done()

            // Create child context from parent
            fetchCtx, cancel := context.WithTimeout(ctx, 30*time.Second)
            defer cancel()

            resp, err := c.Fetch(fetchCtx, f.URL, cache)
            // ...
        }(i, feed)
    }

    // Add context cancellation on interrupt
    done := make(chan struct{})
    go func() {
        wg.Wait()
        close(done)
    }()

    select {
    case <-done:
        return nil
    case <-ctx.Done():
        return ctx.Err()
    }
}
```

**Benefits**:
- Graceful shutdown on Ctrl+C
- Proper cancellation propagation
- Better timeout handling
- Go best practices

**Estimate**: 1 day
**Files**: `cmd/rp/commands.go`, update all cmd* functions

---

### D2.2 Goroutine Leak Prevention

**Problem**: If a goroutine panics or context is cancelled, other goroutines may leak.

**Proposed**:
```go
// Add goroutine leak detection in tests
func TestFetchFeeds_NoGoroutineLeaks(t *testing.T) {
    before := runtime.NumGoroutine()

    // Run fetch
    err := fetchFeeds(context.Background(), cfg)
    require.NoError(t, err)

    // Wait for cleanup
    time.Sleep(100 * time.Millisecond)

    after := runtime.NumGoroutine()
    assert.Equal(t, before, after, "goroutine leak detected")
}
```

**Add Context Cancellation**:
```go
// In fetchFeeds, handle context cancellation properly
for _, feed := range feeds {
    select {
    case <-ctx.Done():
        return ctx.Err()  // Stop spawning new goroutines
    default:
    }

    wg.Add(1)
    go func(f repository.Feed) {
        defer wg.Done()
        // ...
    }(feed)
}
```

**Estimate**: 1 day
**Files**: `cmd/rp/commands.go`, add leak tests

---

## D3: Logging & Observability üìä

### D3.1 Replace Global Logger with Structured Logger

**Problem**: `globalLogger` is a global variable with no context, not thread-safe for level changes.

**Current** (commands.go:34):
```go
var globalLogger = &Logger{level: LogLevelInfo}

func (l *Logger) SetLevel(level string) {
    // Not thread-safe!
    l.level = LogLevelInfo
}
```

**Proposed**: Use structured logging (slog in Go 1.21+):

```go
// pkg/logging/logger.go
type Logger struct {
    slog *slog.Logger
}

func New(level string, output io.Writer) *Logger {
    var logLevel slog.Level
    switch level {
    case "debug":
        logLevel = slog.LevelDebug
    case "info":
        logLevel = slog.LevelInfo
    // ...
    }

    handler := slog.NewTextHandler(output, &slog.HandlerOptions{
        Level: logLevel,
    })

    return &Logger{
        slog: slog.New(handler),
    }
}

func (l *Logger) Info(msg string, args ...any) {
    l.slog.Info(msg, args...)
}

// Usage:
logger.Info("fetching feed",
    "url", feedURL,
    "feed_id", feedID,
    "attempt", retryCount)
```

**Benefits**:
- Structured logs (JSON-parseable)
- Context tracking (request IDs, feed IDs)
- Thread-safe
- Standard library (Go 1.21+)

**Migration Path**:
1. Keep current Logger for backward compatibility
2. Add slog wrapper
3. Migrate gradually
4. Remove old Logger in v2.0

**Estimate**: 2 days
**Files**: Create `pkg/logging/`, update commands.go

---

### D3.2 Add Metrics Collection

**Problem**: No visibility into performance (fetch times, error rates, cache hit rates).

**Proposed**: Add simple metrics:

```go
// pkg/metrics/metrics.go
type Metrics struct {
    FetchTotal        int64
    FetchErrors       int64
    FetchDuration     time.Duration
    CacheHits         int64
    EntriesStored     int64
    BytesFetched      int64
}

// Collect during operation
metrics := &Metrics{}
start := time.Now()
resp, err := c.Fetch(ctx, feedURL, cache)
metrics.FetchDuration += time.Since(start)
if err != nil {
    atomic.AddInt64(&metrics.FetchErrors, 1)
}
if resp.NotModified {
    atomic.AddInt64(&metrics.CacheHits, 1)
}

// Report at end
logger.Info("fetch complete",
    "total_feeds", len(feeds),
    "errors", metrics.FetchErrors,
    "cache_hits", metrics.CacheHits,
    "avg_duration_ms", metrics.FetchDuration.Milliseconds() / int64(len(feeds)))
```

**Estimate**: 1 day
**Files**: Create `pkg/metrics/`, integrate in commands.go

---

## D4: Error Handling üö®

### D4.1 Consistent Sentinel Errors

**Problem**: Some packages export sentinel errors, some don't. Inconsistent wrapping.

**Current**:
```go
// repository.go exports them
var ErrFeedNotFound = errors.New("feed not found")

// crawler.go exports them
var ErrInvalidURL = errors.New("invalid URL")

// normalizer.go doesn't export any
// generator.go doesn't export any
```

**Proposed**: Define package-level errors consistently:

```go
// pkg/normalizer/errors.go
var (
    ErrInvalidFeed = errors.New("invalid feed data")
    ErrNoEntries   = errors.New("feed contains no entries")
    ErrEmptyFeed   = errors.New("feed has no content")
)

// pkg/generator/errors.go
var (
    ErrInvalidTemplate = errors.New("invalid template")
    ErrMissingData     = errors.New("required template data missing")
)
```

**Usage**:
```go
// Caller can check specific errors
if errors.Is(err, normalizer.ErrInvalidFeed) {
    // Handle invalid feed specifically
}
```

**Estimate**: 4 hours
**Files**: Add `errors.go` to each pkg/

---

### D4.2 Error Context Enhancement

**Problem**: Some errors lack context about what operation failed.

**Current**:
```go
if err != nil {
    return fmt.Errorf("update feed: %w", err)
}
```

**Better**:
```go
if err != nil {
    return fmt.Errorf("update feed %s (id=%d): %w", feedURL, feedID, err)
}
```

**Review Checklist**:
- [ ] All database errors include feed/entry identifiers
- [ ] All HTTP errors include URL
- [ ] All parsing errors include source
- [ ] All file operations include path

**Estimate**: 1 day
**Files**: Review all error returns in pkg/

---

## D5: Performance üöÄ

### D5.1 Connection Pooling (ALREADY IN v0.4.0 P5.1)

See Priority 5 above - this is a quick win included in v0.4.0.

---

### D5.2 Database Prepared Statement Reuse

**Problem**: Prepared statements created on each call, not cached.

**Current**: Repository methods create statements each time:
```go
func (r *Repository) AddFeed(url, title string) (int64, error) {
    result, err := r.db.Exec(`INSERT INTO feeds ...`, url, title)
    // Statement prepared and discarded each call
}
```

**Proposed**: Cache prepared statements:

```go
type Repository struct {
    db   *sql.DB
    stmt struct {
        addFeed      *sql.Stmt
        updateFeed   *sql.Stmt
        getFeedByURL *sql.Stmt
        // ...
    }
}

func (r *Repository) prepareStatements() error {
    var err error
    r.stmt.addFeed, err = r.db.Prepare(`INSERT INTO feeds ...`)
    if err != nil {
        return err
    }
    // ... prepare others
    return nil
}

func (r *Repository) AddFeed(url, title string) (int64, error) {
    result, err := r.stmt.addFeed.Exec(url, title)
    // Reuses prepared statement
}
```

**Benefit**: 10-20% faster database operations

**Estimate**: 1 day
**Files**: `pkg/repository/repository.go`

---

### D5.3 Batch Entry Inserts

**Problem**: Entries inserted one-by-one in loop (commands.go:889-910).

**Current**:
```go
for _, entry := range entries {
    repoEntry := &repository.Entry{...}
    if err := repo.UpsertEntry(repoEntry); err != nil {
        // Each call is a separate transaction
    }
}
```

**Proposed**: Batch insert in transaction:

```go
// pkg/repository/repository.go
func (r *Repository) UpsertEntriesBatch(entries []*Entry) error {
    tx, err := r.db.Begin()
    if err != nil {
        return err
    }
    defer tx.Rollback()

    stmt, err := tx.Prepare(`INSERT INTO entries ...`)
    if err != nil {
        return err
    }
    defer stmt.Close()

    for _, entry := range entries {
        if _, err := stmt.Exec(...); err != nil {
            return err
        }
    }

    return tx.Commit()
}
```

**Benefit**: 5-10x faster for feeds with many entries

**Estimate**: 4 hours
**Files**: `pkg/repository/repository.go`

---

## D6: Code Organization üìÅ

### D6.1 Split Large Files

**Files over 500 lines**:
- `pkg/generator/generator.go`: 648 lines (includes 300-line embedded template)
- `pkg/repository/repository.go`: 593 lines

**Proposed**:
```
pkg/generator/
  generator.go          (100 lines - core logic)
  template.go           (200 lines - template functions)
  template_default.go   (300 lines - embedded template)
  formats.go            (50 lines - date/time formatting)
```

```
pkg/repository/
  repository.go         (200 lines - core interface)
  feeds.go              (150 lines - feed operations)
  entries.go            (150 lines - entry operations)
  schema.go             (100 lines - schema & migration)
```

**Estimate**: 1 day
**Files**: Split large files

---

### D6.2 Extract Helper Functions

**Problem**: fetchFeeds() has nested helper logic that could be functions.

**Extract**:
```go
// fetchFeeds() currently has inline:
// - Feed cache preparation (5 lines)
// - Entry conversion (15 lines)
// - Error handling patterns (repeated 3x)

// Proposed helpers:
func prepareFeedCache(feed repository.Feed) crawler.FeedCache { ... }
func convertToRepoEntry(entry normalizer.Entry, feedID int64) *repository.Entry { ... }
func logFetchError(logger *Logger, feedURL string, err error) { ... }
```

**Estimate**: 4 hours
**Files**: `cmd/rp/commands.go`

---

## D7: Configuration üîß

### D7.1 Config Validation on Load (ALREADY IN v0.4.0 P5.2)

See Priority 5 above - this is a quick win included in v0.4.0.

---

### D7.2 Typed Config Errors

**Problem**: Generic error messages for config problems.

**Current**:
```go
return fmt.Errorf("invalid days value: %s", value)
```

**Proposed**:
```go
type ConfigError struct {
    Field   string
    Value   string
    Message string
}

func (e *ConfigError) Error() string {
    return fmt.Sprintf("config.%s: %s (got: %s)", e.Field, e.Message, e.Value)
}

// Usage:
return &ConfigError{
    Field:   "planet.days",
    Value:   value,
    Message: "must be >= 1",
}
```

**Benefit**: Better error messages for users

**Estimate**: 4 hours
**Files**: `pkg/config/config.go`

---

## Implementation Roadmap (Post v1.0.0)

### Phase 1: Foundation (1-2 weeks)
1. Introduce interfaces (D1.1) - 2 days
2. Extract business logic (D1.2) - 3 days
3. Context propagation (D2.1) - 1 day
4. Goroutine leak prevention (D2.2) - 1 day

**Benefits**: Testable architecture, better concurrency

### Phase 2: Testing (1 week)
1. Improve cmd/rp coverage (D1.3) - 2 days
2. Add integration tests with new interfaces - 2 days
3. Add goroutine leak tests - 1 day

**Benefits**: >60% cmd/rp coverage, confidence in refactoring

### Phase 3: Observability (1 week)
1. Structured logging (D3.1) - 2 days
2. Metrics collection (D3.2) - 1 day
3. Error handling improvements (D4.1, D4.2) - 2 days

**Benefits**: Better debugging, performance visibility

### Phase 4: Performance (3-4 days)
1. Connection pooling - DONE in v0.4.0
2. Prepared statement reuse (D5.2) - 1 day
3. Batch inserts (D5.3) - 4 hours
4. Benchmark tests - 1 day

**Benefits**: 2-3x faster fetching

### Phase 5: Organization (3-4 days)
1. Split large files (D6.1) - 1 day
2. Extract helpers (D6.2) - 4 hours
3. Config improvements (D7.2) - 4 hours
4. Documentation updates - 1 day

**Benefits**: Easier maintenance

**Total**: 4-5 weeks of focused work

---

## Success Metrics (v1.1 Release Criteria)

- [ ] Test coverage >60% on cmd/rp (from 26.6%)
- [ ] All packages have interfaces defined
- [ ] Zero goroutine leaks in tests
- [ ] Structured logging with context
- [ ] No file >400 lines
- [ ] 2-3x faster feed fetching (benchmarks)
- [ ] Proper context cancellation (Ctrl+C works)
- [ ] All sentinel errors exported and documented

---

## What's NOT Recommended

These are NOT in scope:
- ‚ùå Rewrite in another language
- ‚ùå Add ORM (SQLite is fine as-is)
- ‚ùå Microservices architecture
- ‚ùå GraphQL API
- ‚ùå Web UI (against project philosophy)

---

**Status**: Ready for post-v1.0.0 implementation
**Priority**: Technical debt reduction, not urgent
**Goal**: Move from B+ to A quality codebase
