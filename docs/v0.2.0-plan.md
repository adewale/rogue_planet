# Rogue Planet v0.2.0 - OPML Support & Quality Release Plan

**Release Goal**: Add OPML import/export, configuration verification, and improve Go standards compliance

**Started**: 2025-10-12
**Target Release**: TBD
**Theme**: Interoperability, Validation & Quality

---

## Overview

Version 0.2.0 focuses on three key areas:

### 1. OPML Support (Primary Feature)
OPML (Outline Processor Markup Language) is the standard format for feed list exchange. Adding OPML support enables:
- Easy migration from other feed aggregators (Feedly, NewsBlur, etc.)
- Backup and restore of feed lists
- Sharing curated feed collections
- Integration with feed management tools

### 2. Configuration Verification (New Command)
The `rp verify` command validates configuration and provides detailed error messages:
- Validates config.ini syntax and values
- Checks database accessibility
- Verifies output directory permissions
- Validates feed URLs in database
- Provides actionable error messages

### 3. Go Standards Compliance (Quality Improvements)
Address findings from Go standards audit (88/100 → 95/100 target):
- Add missing package documentation (CRITICAL)
- Increase generator test coverage (54% → 85%+)
- Fix error message capitalization
- Improve overall code quality

---

## Features

### 1. OPML Import (`rp import-opml`)

**Command**:
```bash
rp import-opml feeds.opml [--config FILE] [--dry-run]
```

**Functionality**:
- Parse OPML 1.0 and 2.0 formats
- Extract feed URLs from `<outline>` elements
- Support both `xmlUrl` and `url` attributes (OPML spec compliance)
- Support both `text` and `title` attributes for feed names (critical compatibility)
- Handle nested categories (flatten for v0.2.0)
- Report success/failure for each feed
- Skip duplicate feeds (already in database)
- Validate feed URLs before adding
- **Dry-run mode**: Show what would be imported without modifying database

**Output**:
```
Importing feeds from feeds.opml...

Found 42 feeds in OPML file

  [1/42] Adding https://example.com/feed.xml (Daring Fireball)
         ✓ Added (ID: 1)
  [2/42] Adding https://blog.example.org/rss (Example Blog)
         ⚠ Skipped (already exists)
  [3/42] Adding https://news.example.net/atom (News Site)
         ✓ Added (ID: 2)
  ...

✓ Successfully imported 38/42 feeds
  - 38 added
  - 4 skipped (duplicates)
```

**Dry-run Output**:
```
DRY RUN: Importing feeds from feeds.opml...

Found 42 feeds in OPML file

  [1/42] Would add: https://example.com/feed.xml (Daring Fireball)
  [2/42] Would skip: https://blog.example.org/rss (already exists)
  [3/42] Would add: https://news.example.net/atom (News Site)
  ...

DRY RUN: Would import 38/42 feeds (4 duplicates skipped)
```

**Error Handling**:
- Invalid OPML format → clear error message
- Malformed feed URLs → skip with warning
- Empty OPML → informative message

---

### 2. OPML Export (`rp export-opml`)

**Command**:
```bash
rp export-opml [--output FILE] [--config FILE]
```

**Functionality**:
- Generate OPML 2.0 format (backward compatible with 1.0 readers)
- Include all feeds from database
- Add feed metadata (title from database)
- Use both `text` and `title` attributes (maximum compatibility)
- RFC 822 formatted dates in headers (OPML spec requirement)
- Output to file or stdout (preview with stdout)
- Pretty-print XML with indentation

**Output** (to stdout by default):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<opml version="2.0">
  <head>
    <title>Rogue Planet Feed List</title>
    <dateCreated>Sat, 12 Oct 2025 20:30:00 GMT</dateCreated>
    <ownerName>Your Name</ownerName>
  </head>
  <body>
    <outline text="Daring Fireball" type="rss" xmlUrl="https://daringfireball.net/feeds/main" htmlUrl="https://daringfireball.net/"/>
    <outline text="Asymco" type="rss" xmlUrl="https://asymco.com/feed/" htmlUrl="https://asymco.com/"/>
  </body>
</opml>
```

**Usage Examples**:
```bash
# Export to file
rp export-opml --output feeds.opml

# Preview to stdout (pipe to less for scrolling)
rp export-opml | less

# Export with custom config
rp export-opml --output backup.opml --config /path/to/config.ini
```

---

### 3. Configuration Verification (`rp verify`)

**Command**:
```bash
rp verify [--config FILE]
```

**Functionality**:
- Validate config.ini syntax and values
- Check database file accessibility and schema
- Verify output directory exists and is writable
- Validate feed URLs in database (basic syntax check)
- Check for common misconfigurations
- Provide actionable error messages with suggestions

**Output (success)**:
```
✓ Configuration valid (15 feeds, 342 entries)
```

**Output (with errors)**:
```
✗ Configuration validation failed

- Invalid config value: days = 0 (must be >= 1)
- Database does not exist → run 'rp init' to create
- Output directory not writable → chmod 755 ./public

Found 3 errors.
```

**Validation Checks**:
1. **Config File**: Syntax, required fields, value ranges
2. **Database**: File exists, readable, valid schema
3. **Output Directory**: Exists, writable
4. **Feeds**: Valid URL format
5. **Template**: File exists if custom template specified

---

## Implementation Plan

### Phase 0: Package Documentation (Day 1 - 2 hours)

**CRITICAL**: Add package-level documentation to all packages for godoc

**Files to update**:
- `pkg/crawler/crawler.go` - Add package doc
- `pkg/normalizer/normalizer.go` - Add package doc
- `pkg/repository/repository.go` - Add package doc
- `pkg/generator/generator.go` - Add package doc
- `pkg/config/config.go` - Add package doc
- `pkg/opml/opml.go` - Add package doc (new package)

**Example format**:
```go
// Package crawler provides HTTP fetching for RSS/Atom feeds with conditional request support.
//
// The crawler implements proper HTTP caching using ETag and Last-Modified headers,
// SSRF prevention, and response size limiting. It is designed to be a well-behaved
// feed fetcher that minimizes bandwidth and server load.
package crawler
```

### Phase 0.5: Verify Command (2.5 hours)

**File**: `cmd/rp/commands.go`

```go
// VerifyOptions configures the verify command
type VerifyOptions struct {
    ConfigPath string
    Output     io.Writer
}

// cmdVerify validates configuration and environment
func cmdVerify(opts VerifyOptions) error {
    // 1. Load and validate config file
    // 2. Check database accessibility and schema
    // 3. Verify output directory permissions
    // 4. Validate feed URLs in database
    // 5. Check custom template if specified
    // 6. Report errors only (brief success message)
}
```

**File**: `cmd/rp/main.go` - Add command:
```go
case "verify":
    runVerify()
```

**Tests**: `cmd/rp/commands_test.go`
- Detect invalid config values
- Detect missing database
- Detect unwritable output directory
- Brief output format

---

### Phase 1: OPML Package (6 hours)

**File**: `pkg/opml/opml.go`

```go
package opml

import (
    "encoding/xml"
    "time"
)

// OPML represents the root OPML structure
type OPML struct {
    XMLName xml.Name `xml:"opml"`
    Version string   `xml:"version,attr"`
    Head    Head     `xml:"head"`
    Body    Body     `xml:"body"`
}

// Head contains metadata
type Head struct {
    Title       string `xml:"title"`
    DateCreated string `xml:"dateCreated"` // RFC 822 format per OPML spec
    OwnerName   string `xml:"ownerName,omitempty"`
    OwnerEmail  string `xml:"ownerEmail,omitempty"`
}

// Body contains outlines (feeds)
type Body struct {
    Outlines []Outline `xml:"outline"`
}

// Outline represents a feed or category
type Outline struct {
    Text    string     `xml:"text,attr"`              // Required by OPML spec
    Title   string     `xml:"title,attr,omitempty"`   // CRITICAL: Many readers expect this
    Type    string     `xml:"type,attr,omitempty"`    // "rss", "atom", etc.
    XMLUrl  string     `xml:"xmlUrl,attr,omitempty"`  // Feed URL (OPML 2.0)
    Url     string     `xml:"url,attr,omitempty"`     // Feed URL (OPML 1.0 compatibility)
    HTMLUrl string     `xml:"htmlUrl,attr,omitempty"` // Website URL

    // For nested categories
    Outlines []Outline `xml:"outline,omitempty"`
}

// Parse parses an OPML file
func Parse(data []byte) (*OPML, error)

// ParseFile parses an OPML file from disk
func ParseFile(path string) (*OPML, error)

// ExtractFeeds extracts all feed URLs from OPML (flatten nested)
func (o *OPML) ExtractFeeds() []Feed

// Feed represents an extracted feed
type Feed struct {
    Title   string
    FeedURL string
    WebURL  string
}

// Generate creates OPML from feed list
func Generate(feeds []Feed, metadata Metadata) (*OPML, error)

// Metadata for OPML generation
type Metadata struct {
    Title      string
    OwnerName  string
    OwnerEmail string
}

// Marshal serializes OPML to XML bytes
func (o *OPML) Marshal() ([]byte, error)

// Write writes OPML to file
func (o *OPML) Write(path string) error

// FormatRFC822 converts time.Time to RFC 822 format (OPML spec requirement)
func FormatRFC822(t time.Time) string

// ParseRFC822 parses RFC 822 date string to time.Time
func ParseRFC822(s string) (time.Time, error)
```

**Tests**: `pkg/opml/opml_test.go`

**OPML Spec Compliance (52 test cases from research)**:
- Parse valid OPML 1.0 and 2.0
- Handle both `xmlUrl` and `url` attributes
- Handle both `text` and `title` attributes (CRITICAL)
- **RFC 822 date handling** (OPML spec requirement):
  - Parse RFC 822 dates from OPML files
  - Convert time.Time to RFC 822 for export
  - Test round-trip date conversion (ISO 8601 → RFC 822 → ISO 8601)
- Handle nested outlines (flatten for v0.2.0)
- Extract feeds correctly
- Generate valid OPML 2.0
- Handle empty OPML
- Handle malformed XML
- Preserve feed metadata (title, htmlUrl, type)
- Handle missing required attributes gracefully
- Support common feed types (rss, atom, etc.)
- Handle special characters in feed titles
- Parse dateCreated and dateModified
- Support ownerName and ownerEmail
- Handle CDATA sections
- Test with real OPML files from Feedly, NewsBlur, Inoreader

**Coverage target**: 85%+

---

### Phase 2: Import Command (4 hours)

**File**: `cmd/rp/commands.go`

```go
// ImportOPMLOptions configures the import-opml command
type ImportOPMLOptions struct {
    OPMLFile   string
    ConfigPath string
    DryRun     bool // Show what would be imported without importing
    Output     io.Writer
}

// cmdImportOPML imports feeds from OPML file
func cmdImportOPML(opts ImportOPMLOptions) error {
    // 1. Parse OPML file
    // 2. Extract feed URLs (handle both xmlUrl and url attributes)
    // 3. Extract feed titles (prefer title, fallback to text)
    // 4. Load config and open database (skip if dry-run)
    // 5. For each feed:
    //    - Check if already exists
    //    - Validate URL (SSRF check)
    //    - Add to database (or report in dry-run)
    //    - Report status
    // 6. Print summary
}
```

**File**: `cmd/rp/main.go` - Add command:
```go
case "import-opml":
    runImportOPML()
```

**Tests**: `cmd/rp/commands_test.go`
- Import valid OPML 1.0 and 2.0
- Skip duplicate feeds
- Handle missing file
- Dry-run mode (no database changes)
- Report statistics correctly
- Handle text vs title attributes
- Handle xmlUrl vs url attributes
- Validate URLs (reject invalid/private IPs)

---

### Phase 3: Export Command (2.5 hours)

**File**: `cmd/rp/commands.go`

```go
// ExportOPMLOptions configures the export-opml command
type ExportOPMLOptions struct {
    OutputFile string    // Empty = stdout
    ConfigPath string
    Output     io.Writer // For testing
}

// cmdExportOPML exports feeds to OPML
func cmdExportOPML(opts ExportOPMLOptions) error {
    // 1. Load config and open database
    // 2. Get all feeds from repository
    // 3. Generate OPML structure
    //    - Set both text and title attributes (maximum compatibility)
    //    - Convert current time to RFC 822 format (OPML spec)
    //    - Include owner info from config
    // 4. Marshal to XML with indentation
    // 5. Write to file or stdout
}
```

**File**: `cmd/rp/main.go` - Add command:
```go
case "export-opml":
    runExportOPML()
```

**Tests**: `cmd/rp/commands_test.go`
- Export feeds to OPML 2.0
- Export to stdout
- Export to file
- Handle empty database
- Valid XML output
- Verify both text and title attributes present
- Verify RFC 822 date format (using FormatRFC822)
- Verify owner info included

---

### Phase 4: Generator Test Coverage (3 hours)

**CRITICAL**: Increase generator test coverage from 54% to 85%+

**File**: `pkg/generator/generator_test.go`

**Add tests for**:
- Template variable population
- Date grouping logic
- Feed sidebar rendering
- Error handling (missing template, invalid data)
- Edge cases (no entries, no feeds, malformed dates)
- Custom template loading
- Static file copying
- HTML escaping verification

**Coverage target**: 85%+

---

### Phase 5: Integration Tests (2 hours)

**File**: `cmd/rp/opml_integration_test.go`

Tests:
1. **Round-trip test**: Export → Import → Verify same feeds
2. **Real OPML files**: Test with OPML from Feedly, NewsBlur, Inoreader
3. **Edge cases**: Empty OPML, nested categories, missing attributes
4. **End-to-end**: Init → Add feeds → Export → New planet → Import → Verify
5. **Dry-run verification**: Ensure import --dry-run doesn't modify database
6. **Verify command**: Test all validation checks
7. **Date handling**: Verify RFC 822 dates in exported OPML

---

### Phase 6: Error Message Audit (1 hour)

**Fix error message capitalization** (Go convention: lowercase, no punctuation)

**Files to audit**:
- All error messages in pkg/ packages
- All user-facing error messages in cmd/rp/

**Pattern**:
```go
// Wrong:
return fmt.Errorf("Failed to parse feed")

// Correct:
return fmt.Errorf("failed to parse feed")
```

---

### Phase 7: Documentation (2 hours)

**Update Files**:
1. **README.md** - Add OPML section and verify command
2. **QUICKSTART.md** - Add import-opml example
3. **WORKFLOWS.md** - Add "Importing from Other Aggregators" section
4. **CLAUDE.md** - Document OPML package and verify command
5. **CHANGELOG.md** - Add v0.2.0 entry

**New Content**:

**README.md additions**:
```markdown
### OPML Support

Import feed lists from other aggregators:
```bash
# Preview what would be imported
rp import-opml feeds.opml --dry-run

# Actually import
rp import-opml feeds.opml
```

Export your feed list for backup or sharing:
```bash
# Preview to stdout
rp export-opml

# Export to file
rp export-opml --output feeds.opml
```

### Configuration Verification

Validate your configuration before deployment:
```bash
rp verify
```
```

**WORKFLOWS.md addition**:
```markdown
## Migrating from Other Feed Aggregators

### Import from Feedly, NewsBlur, Inoreader, etc.

1. Export OPML from your current aggregator
2. Preview the import:
   ```bash
   rp init
   rp import-opml feeds.opml --dry-run
   ```
3. Import for real:
   ```bash
   rp import-opml feeds.opml
   rp update
   ```

### Backup Your Feed List

```bash
rp export-opml --output backup-$(date +%Y%m%d).opml
```

### Verify Configuration

```bash
# Check configuration, database, and permissions
rp verify
```
```

---

## Testing Strategy

### Unit Tests
- ✅ OPML parsing (valid/invalid)
- ✅ Feed extraction
- ✅ OPML generation
- ✅ XML marshaling

### Integration Tests
- ✅ Import command end-to-end
- ✅ Export command end-to-end
- ✅ Round-trip (export → import)

### Real-World Tests
- ✅ Test with OPML from Feedly
- ✅ Test with OPML from NewsBlur
- ✅ Test with nested categories
- ✅ Test with 100+ feeds

### Test Coverage Target
- `pkg/opml`: 85%+
- `pkg/generator`: 85%+
- Import/Export commands: 85%+

---

## Dependencies

**New Dependencies**: None! Use Go standard library:
- `encoding/xml` - OPML parsing/generation
- `os` - File I/O
- `time` - Timestamps

---

## Compatibility

### OPML Versions
- ✅ OPML 1.0 (read)
- ✅ OPML 2.0 (read/write)

### Tested Aggregators
- [ ] Feedly
- [ ] NewsBlur
- [ ] Inoreader
- [ ] The Old Reader
- [ ] FreshRSS
- [ ] Miniflux

---

## Timeline

**Day 1** (8 hours):
- **Phase 0** (2h): Add package documentation to all packages (CRITICAL)
- **Phase 0.5** (2.5h): Implement `rp verify` command with tests
- **Phase 1** (3.5h): Start OPML package implementation

**Day 2** (8 hours):
- **Phase 1** (2.5h): Complete OPML package with full spec compliance (52 test cases)
- **Phase 2** (4h): Implement `rp import-opml` command with --dry-run
- **Phase 3** (1.5h): Start `rp export-opml` command

**Day 3** (7 hours):
- **Phase 3** (1h): Complete `rp export-opml` command
- **Phase 4** (3h): Increase generator test coverage (54% → 85%+)
- **Phase 5** (2h): Integration tests (round-trip, real OPML files, RFC 822 dates)
- **Phase 6** (1h): Error message audit and fixes

**Day 4** (2 hours):
- **Phase 7** (2h): Documentation updates (README, WORKFLOWS, QUICKSTART, CHANGELOG, CLAUDE.md)

**Total Estimate**: 25 hours (~3 days)

**Breakdown by focus area**:
- OPML Support: 12.5 hours (50%)
- Go Standards Compliance: 6 hours (24%)
- Configuration Verification: 2.5 hours (10%)
- Documentation: 2 hours (8%)
- Integration/Polish: 2 hours (8%)

**Time saved from simplifications**: 3 hours
- Removed export --dry-run: -0.5h
- Simplified verify output: -0.5h
- Removed disk space check: -0.25h
- Other minor refinements: -0.25h
- Better time allocation: -1.5h

---

## Success Criteria

### OPML Support
- ✅ Import OPML from major aggregators (Feedly, NewsBlur, Inoreader)
- ✅ Export valid OPML 2.0 (backward compatible with 1.0)
- ✅ Handle both text/title and xmlUrl/url attributes correctly
- ✅ RFC 822 date format support (parse and generate with tests)
- ✅ Round-trip test passes (export → import → identical feeds)
- ✅ --dry-run mode for import
- ✅ 85%+ test coverage on OPML package
- ✅ 52 OPML spec compliance tests pass

### Configuration Verification
- ✅ `rp verify` command validates all configuration
- ✅ Provides actionable error messages (brief, focused output)
- ✅ Checks database, output dir, permissions
- ✅ Comprehensive test coverage

### Go Standards Compliance
- ✅ All packages have documentation (godoc ready)
- ✅ Generator test coverage 85%+ (from 54%)
- ✅ Error messages follow Go conventions (lowercase)
- ✅ Codebase score 95/100+ (from 88/100)

### General
- ✅ Documentation complete (README, WORKFLOWS, QUICKSTART, CHANGELOG, CLAUDE.md)
- ✅ Zero new dependencies
- ✅ All existing tests still pass
- ✅ Commands use consistent naming (import-opml, export-opml, verify)
- ✅ Consistent 85% test coverage target across all new code

---

## Future Enhancements (v0.3.0+)

- [ ] Category preservation (tags)
- [ ] Selective import (filter by category)
- [ ] Merge mode (import into existing database)
- [ ] OPML validation tool
- [ ] Auto-backup to OPML on update

---

## Commands Summary

### Before v0.2.0
```bash
rp init [-f FILE]
rp add-feed <url>
rp add-all -f FILE
rp remove-feed <url>
rp list-feeds
rp status
rp update
rp fetch
rp generate
rp prune --days N
rp version
```

### After v0.2.0 (NEW - 3 commands)
```bash
rp import-opml <file> [--config FILE] [--dry-run]
rp export-opml [--output FILE] [--config FILE]
rp verify [--config FILE]
```

---

## Key Implementation Notes

### OPML Compatibility (CRITICAL)

**Text vs Title Attributes:**
Many OPML readers expect BOTH `text` and `title` attributes, even though spec only requires `text`. For maximum compatibility:
```xml
<!-- Always output both -->
<outline text="Feed Name" title="Feed Name" xmlUrl="..." />
```

**URL Attributes:**
Support both `xmlUrl` (OPML 2.0) and `url` (OPML 1.0) on import:
```go
feedURL := outline.XMLUrl
if feedURL == "" {
    feedURL = outline.Url  // Fallback for OPML 1.0
}
```

**RFC 822 Date Format (OPML Spec Requirement):**
OPML spec requires RFC 822 dates. We use ISO 8601 internally, so translation layer is needed:
```go
// pkg/opml/opml.go

// FormatRFC822 converts time.Time to RFC 822 format for OPML
// Example: "Mon, 02 Jan 2006 15:04:05 -0700"
func FormatRFC822(t time.Time) string {
    return t.Format(time.RFC1123Z)
}

// ParseRFC822 parses RFC 822 date to time.Time
func ParseRFC822(s string) (time.Time, error) {
    return time.Parse(time.RFC1123Z, s)
}
```

**Tests must verify**:
- Round-trip: ISO 8601 → RFC 822 → ISO 8601
- Parse real OPML dates from Feedly, NewsBlur
- Export uses RFC 822 format

### Go Standards Compliance
- **Package docs**: First comment in package must be `// Package name ...`
- **Error messages**: Lowercase, no punctuation: `fmt.Errorf("failed to parse feed")`
- **Test coverage**: Use table-driven tests, aim for 85%+
- **io.Writer pattern**: All commands should accept io.Writer for testability

### Testing Strategy
1. **Unit tests**: Each component in isolation
2. **Integration tests**: Round-trip (export → import)
3. **Real-world tests**: Actual OPML files from major aggregators
4. **Spec compliance**: All 52 test cases from research

### Branch Strategy
Work directly on `main` branch as per user request (not a development branch)

---

**Status**: Planning Complete ✅ (Consistency reviewed, simplified)
**Next Step**: Begin Phase 0 - Add package documentation (CRITICAL)

---

## Changes from Initial Plan

**Simplifications Applied**:
1. ✅ Removed export --dry-run (use stdout for preview)
2. ✅ Removed disk space check from verify (unnecessary)
3. ✅ Simplified verify output (brief, error-focused)
4. ✅ Consistent 85% coverage target across all packages
5. ✅ Fixed timeline phase headers (removed day numbers)
6. ✅ Combined database schema/corruption check into one

**Retained from User Feedback**:
1. ✅ All 52 OPML test cases (comprehensive spec compliance)
2. ✅ RFC 822 date support (OPML spec requirement)
3. ✅ Clear translation layer with tests (ISO 8601 ↔ RFC 822)

**Result**: 25 hours (down from 26), clearer scope, better consistency

---

*Created: 2025-10-12*
*Updated: 2025-10-12 (added verify command, Go standards compliance, consistency review)*
*Target: Rogue Planet v0.2.0*
